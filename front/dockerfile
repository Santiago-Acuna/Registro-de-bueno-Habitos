# Use an official Node.js runtime as the base image
FROM node:22.9.0-slim

# Set the working directory in the container
WORKDIR /app

# Set the DISPLAY environment variable to forward the UI
RUN echo $DISPLAY > /tmp/display_value

# Install system dependencies for Electron and GTK modules
RUN apt-get update && apt-get install -y \
    libgtk-3-0 \
    libx11-xcb1 \
    libasound2 \
    libnss3 \
    libxss1 \
    libxtst6 \
    libxrandr2 \
    libgl1-mesa-glx \
    libgbm1 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libcanberra-gtk-module \
    libcanberra-gtk3-module \
    policykit-1-gnome \
    && rm -rf /var/lib/apt/lists/*

# Install Electron and Vite dependencies
COPY package*.json ./
RUN npm install

# Create a non-root user and group
RUN groupadd -r electron && useradd -r -m -g electron electron

# Set ownership of /app to the non-root user before copying other files
RUN chown -R electron:electron /app

# Copy the rest of the application files
COPY --chown=electron:electron . .

# Set correct permissions for the chrome-sandbox helper binary at the end
RUN chown root:root /app/node_modules/electron/dist/chrome-sandbox \
    && chmod 4755 /app/node_modules/electron/dist/chrome-sandbox

# Switch to the non-root user
USER electron

# Build the Vite app as the non-root user
RUN npm run build

# Run the Electron app
CMD ["npm", "start"]
